task:
  trigger_type: manual
  matrix:
    - name: Linux - RD E2E/Integration Tests
      timeout_in: 30
      container:
        image: ubuntu:20.04
        kvm: true
        cpu: 4
        memory: 8G
      env:
        DEBIAN_FRONTEND: noninteractive 
      install_deps_script: |
        apt-get update
        apt-get install -y --no-install-recommends apt-transport-https ca-certificates gcc g++ curl git golang openssh-client make netcat sudo qemu-system-x86 qemu-utils
        curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - && apt-get install -y nodejs && node --version && npm -v
        apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
        curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
        echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list
        apt-get update && apt-get install -y kubectl

    # - name: macOS - RD E2E/Integration Tests
    #   timeout_in: 30
    #   osx_instance:
    #     image: big-sur-base
    #     kvm: true
    #   install_deps_script: |
    #     brew install node
    #     node -v && npm -v



  prepate_user_script:
    - useradd -m -G kvm testuser
    
  build_script: |
    npm install

  node_modules_cache:
    fingerprint_script: cat package-lock.json
    folder: /home/testuser/.cache/rancher-desktop

  fix_cache_perm_script: chown -R testuser.testuser /home/testuser

  test_script: |
    chmod +x ./node_modules
    sudo -iu testuser npm run test:e2e:ci
  
  binaries_artifacts:
    path: "/root/.local/share/rancher-desktop/logs/*"
  always:
    rancher_logs:
      path: "/root/.local/share/rancher-desktop/logs/*"
      formart: zip
    